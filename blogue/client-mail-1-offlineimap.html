<!DOCTYPE html>
<html dir="ltr" xml:lang="en" lang="en">
<head>
    <title>Gérer ses mails en local : étape 1, sychronisation IMAP avec OfflineIMAP. - Ted écrit des trucs</title>
  <meta http-equiv="Content-type" content="text/html; charset=utf-8" />
  <meta name="author" content="Damien Desfontaines" />
  <meta name="twitter:creator" content="@TedOnPrivacy" />
  <!-- suggested by rebecca on streambed to fix a zoomed-out display issue on mobile -->
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="/style/menu.css" type="text/css" />
  <link rel="stylesheet" href="/style/blog.css" type="text/css" media="screen" />
  <link rel="stylesheet" href="/style/blog-mobile.css" type="text/css" media="(max-width: 580px)" />
  <link rel="stylesheet" href="/style/blog-print.css" type="text/css" media="print" />
  <link rel="stylesheet" href="/style/pygments.css" type="text/css" />
  <link rel="contents" href="archives.html" />
  <link rel="icon" href="/favicon.ico" sizes="any">
  <link rel="icon" href="/favicon.svg" type="image/svg+xml">
  <link rel="apple-touch-icon" href="/apple-touch-icon.png">
  <link rel="manifest" href="/site.webmanifest">
  <link href="https://desfontain.es/blogue/" type="application/rss+xml" rel="alternate" title="Ted écrit des trucs - RSS Feed" />

  <meta name="title" property="og:title" content="Gérer ses mails en local : étape 1, sychronisation IMAP avec OfflineIMAP. - Ted écrit des trucs" />
  <meta property="twitter:title" content="Gérer ses mails en local : étape 1, sychronisation IMAP avec OfflineIMAP. - Ted écrit des trucs" />
  <meta name="description" property="og:description" content="Comment se connecter à un serveur IMAP et synchroniser ses mails avec OfflineIMAP." />
  <meta property="twitter:description" content="Comment se connecter à un serveur IMAP et synchroniser ses mails avec OfflineIMAP." />
  <meta property="summary" content="Comment se connecter à un serveur IMAP et synchroniser ses mails avec OfflineIMAP." />
  <meta name="twitter:card" content="summary"/>
  <link rel="canonical" href="https://desfontain.es/blogue/client-mail-1-offlineimap.html" />
  <link rel="prev" href="client-mail-2-msmtp.html" />
  <link rel="next" href="client-mail-0-introduction.html" />
  <style type="text/css">
    <!--
        span.baddirection { unicode-bidi:bidi-override; direction: rtl; }
    -->
  </style>
</head>

<body id="index" class="home">
  <!-- also suggested by rebecca, to allow screen readers to skip the menu -->
  <a aria-label="Aller vers le contenu" href="#contenu"></a>
  <div id="menuGlobal">
    <table>
      <tr>
        <td>
          <a href="../index.html">
              ..<span id='joueur'>@</span>..<span class='blue'>♦</span>.<span class='red'>D</span>.
              <img src="../flag-uk.png" alt=""/>
          </a>
        </td>
        <td>
          <a href="../serious-fr.html"> Présentation <img src="../flag-france.gif" alt=""/></a>
          <a href="../serious.html"><img src="../flag-uk.png" alt=""/></a>
        </td>
        <td id="menuCourant">
          Blog <img src="../flag-france.gif" alt=""/>
          <a href="../blog/index.html"><img src="../flag-uk.png" alt=""/></a>
        </td>
        <td>
          <a href="../recettes/index.html">Recettes <img src="../flag-france.gif" alt=""/></a>
        </td>
      </tr>
      <tr id="sousMenu">
        <td colspan="4">
          <span class="gauche">
            <a href="feed.xml">rss</a> —
            <a href="archives.html">archives</a>
          </span>
          <span class="droite">
            <a href="offlineimap-mbsync.html"
                 title="Passer d'OfflineIMAP à isync/mbsync">← précédent</a>
          </span>
        </td>
      </tr>
    </table>
  </div>
  <div id="container">
    <header>
      <h1><a href="./">
        <span property="dct:title">Ted écrit des trucs</span>
      </a></h1>
      Sur des sujets en lien avec la vie privée, ou parfois pas.
    </header>

<article id="contenu">
  <header>
  <h1>
    <a href="./client-mail-1-offlineimap.html">Gérer ses mails en local : étape 1, sychronisation IMAP avec OfflineIMAP.</a>
  </h1>
  </header>
  <footer>
    <time datetime="2014-04-08T00:00:00+02:00">
      2014-04-08
    </time>
    <small>&mdash; modifié le
      <time datetime="2014-05-27T00:00:00+02:00">
        2014-05-27
      </time>
    </small>
  </footer>
  <div>
    <p><span class='notlettrine'>C</span>e billet fait partie d'une série d'articles
présentant la façon dont je gère mes mails en local. Si vous êtes arrivés là
sans lire l'introduction, c'est probablement une bonne idée de commencer par le
début.</p>
<ul>
<li>Étape 0 : <a href="client-mail-0-introduction.html">Introduction</a></li>
<li>Étape 1 : Synchronisation IMAP avec OfflineIMAP ← vous êtes ici !</li>
<li>Étape 2 : <a href="client-mail-2-msmtp.html">Envoi d'e-mails avec msmtp et msmtpq</a></li>
<li>Étape 3 : <a href="client-mail-3-mutt.html">Configuration de mutt</a></li>
<li>Étape 3 bis : <a href="client-mail-3bis-mutt.html">Dose supplémentaire de mutt</a></li>
<li>Étape 4 : <a href="client-mail-4-gpg.html">Chiffrement et signature avec PGP</a></li>
</ul>
<hr>
<p><span class='lettrine'>D</span><strong>onc</strong>, OfflineIMAP est un utilitaire qui va
aller se connecter à un serveur IMAP et copier tout ce qu'il y a dedans. En
fait, il va même faire mieux que ça : il va synchroniser tout ce qui se passe
d'un côté de l'autre, pour que ce soit toujours le même contenu qui soit sur le
serveur et sur le client. Par exemple, si je me connecte avec OfflineIMAP à une
adresse GMail, que je récupère un message non lu et que je l'ouvre avec un
client mail, à la prochaine exécution de OfflineIMAP, il va envoyer au serveur
« C'est bon, tu peux noter que ce mail a été lu ». De la même façon, si je
supprime un mail du côté client, ça va le supprimer sur le serveur - bien
entendu, ce comportement par défaut peut être changé.</p>
<p>Donc, commençons par le début. </p>
<h1 id="installation-et-configuration">Installation et configuration</h1>
<p>On installe OfflineIMAP :</p>
<div class="highlight"><pre><span></span><code>aptitude install offlineimap
</code></pre></div>

<p>on crée un dossier pour mettre les mails qu'on va récupérer :</p>
<div class="highlight"><pre><span></span><code>mkdir ~/Mail
</code></pre></div>

<p>et on modifie le fichier de config', <code>~/.offlineimaprc</code> (en le créant si ça n'a
pas été fait automatiquement lors de l'installation).</p>
<p>Le fichier de config' de OfflineIMAP est très simple à comprendre et à modifier.
Il commence par une section <code>[general]</code> qui va contenir des morceaux de
configuration globale :</p>
<div class="highlight"><pre><span></span><code><span class="k">[general]</span>
<span class="na">accounts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">dam,spam,ddf</span>
<span class="na">ui</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">quiet</span>
</code></pre></div>

<p>ici, la ligne <code>accounts = dam,spam,ddf</code> déclare les différents comptes auxquels
il va se connecter, et la ligne <code>ui = quiet</code> signifie que lorsqu'on lance
<code>offlineimap</code>, on ne veut pas qu'il pose de questions à l'utilisateur (ce qui
est logique, étant donné qu'on va exécuter cette commande automatiquement plus
tard). Changez <code>dam,spam,ddf</code> en des noms (quelconques) pour reconnaître vos
différentes adresses mail avant de poursuivre.</p>
<p>Pour chaque compte <code>c</code> ainsi défini, on va ajouter trois sections : <code>[Account
c]</code>, <code>[Repository c_local]</code> et <code>[Repository c_remote]</code>. Voici par exemple ce que
contient la section pour mon compte nommé <code>dam</code> :</p>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">Account</span><span class="w"> </span><span class="n">dam</span><span class="p">]</span><span class="w">    </span>
<span class="n">localrepository</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">damien_local</span>
<span class="n">remoterepository</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">damien_remote</span>

<span class="p">[</span><span class="n">Repository</span><span class="w"> </span><span class="n">dam_local</span><span class="p">]</span>
<span class="n">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Maildir</span>
<span class="n">localfolders</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">~/</span><span class="n">Mail</span><span class="o">/</span><span class="n">ikura_damien</span><span class="o">/</span>

<span class="p">[</span><span class="n">Repository</span><span class="w"> </span><span class="n">dam_remote</span><span class="p">]</span>
<span class="n">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">IMAP</span>
<span class="n">remotehost</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">desfontain</span><span class="p">.</span><span class="n">es</span>
<span class="n">remoteuser</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">damien</span>
<span class="n">remotepass</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nyyunvygbgururyvksbffvy</span>
<span class="n">ssl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">yes</span>
<span class="n">sslcacertfile</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">ssl</span><span class="o">/</span><span class="n">certs</span><span class="o">/</span><span class="n">ca</span><span class="o">-</span><span class="n">certificates</span><span class="p">.</span><span class="n">crt</span>
</code></pre></div>

<p>La plupart des lignes se comprennent immédiatement.</p>
<ul>
<li>Les trois premières sont juste des déclarations pour la suite.</li>
<li>La section <code>[Repository dam_local]</code> contient des informations comme le type de
  la boîte mail locale (« Veut-on stocker tous ses mails dans un seul gros
  fichier ou bien plutôt avoir un fichier par e-mail dans un gros dossier ? » -
  la bonne réponse à cette question est « un fichier par e-mail », d'où le type
  <code>Maildir</code> et non pas <code>Mailbox</code>), et le dossier qui va contenir les mails de ce
  compte.</li>
<li>La section <code>[Repository dam_remote]</code> contient le type de la connexion
  distante, l'adresse du serveur, l'utilisateur, le mot de passe, le fait qu'on
  utilise SSL et l'emplacement des certificats. Si votre adresse est
  <code>truc@machin.com</code>, vous avez probablement envie de remplacer <code>damien</code> par
  <code>truc</code> et <code>desfontain.es</code> par <code>imap.machin.com</code>, ou <code>machin.com</code>, ou encore
  autre chose suivant le nom du serveur IMAP auquel vous voulez vous connectez.
  Les noms des serveurs IMAP des principaux fournisseurs d'accès sont trouvables
  <a href="http://www.commentcamarche.net/faq/893-parametres-de-serveurs-pop-imap-et-smtp-des-principaux-fai">par
  ici</a>.
  Bien sûr, il faut aussi remplacer le mot de passe. Les deux commandes
  concernant SSL sont <em>importantes</em>, sans ça, votre mot de passe va joyeusement
  voyager en clair jusqu'au serveur.</li>
</ul>
<p>Cette configuration marche si vous avez votre propre serveur IMAP, et fonctionne
pour à peu près tous les fournisseurs de mail… Sauf GMail, qui a une
configuration aussi bizarre que décriée par ceux qui programment des logiciels
comme OfflineIMAP. Pour synchroniser une adresse GMail, la section <code>remote</code> doit
ressembler à :</p>
<div class="highlight"><pre><span></span><code><span class="k">type</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">Gmail</span>
<span class="nx">remoteuser</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">ddfontaines</span><span class="err">@</span><span class="nx">gmail</span><span class="p">.</span><span class="nx">com</span>
<span class="nx">remotepass</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">eryrnfrgursnyfrcebcurg</span>
<span class="nx">realdelete</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">no</span>
</code></pre></div>

<p>où <code>realdelete</code> vaut <code>no</code> si l'on veut que supprimer un mail en local le mette
dans la corbeille de GMail, et <code>yes</code> si on veut le supprimer du serveur « pour
de vrai ».</p>
<h1 id="automatisation-avec-cron">Automatisation avec cron</h1>
<p>On n'a clairement pas envie de taper <code>offlineimap</code> dans une console à chaque
fois que l'on veut récupérer ses mails. Il convient donc de dire au système de
faire ça tout seul comme un grand. Pour ça, on utilise <code>cron</code>, installé de base
sous Debian et dérivés, programme qui lit un fichier de configuration et exécute
les commandes qu'il y a dedans à intervalles réguliers. Pour modifier ce
fichier, on tape dans une console :</p>
<div class="highlight"><pre><span></span><code>`crontab -e`
</code></pre></div>

<p>et on rajoute une ligne ressemblant à ça :</p>
<div class="highlight"><pre><span></span><code>`*/2 <span class="gs">* *</span> * * /usr/bin/offlineimap &gt; /dev/null 2&gt; /dev/null
</code></pre></div>

<p>en remplaçant les deux <code>/dev/null</code> par les endroits où on veut logger ce que
renvoie la commande, si on a envie de le faire. Le <code>*/2 * * * *</code> signifie
« toutes les deux minutes », et on peut le modifier pour changer la fréquence à
laquelle on veut que le système aille chercher les nouveaux messages. Pour plus
d'informations sur la syntaxe de cron, on peut aller voir <a href="https://fr.wikipedia.org/wiki/Crontab">sa page
Wikipédia</a>, par exemple.</p>
<p>Il y aurait plus à dire sur OfflineIMAP, notamment la possibilité de ne
récupérer que certains dossiers d'un compte sur un serveur IMAP, mais ça sort du
cadre de ce billet.</p>
  </div>
</article>

<p><center><button id="showBibtex">Citez cet article!</button></center></p>
<div id="bibtex" style="display: none">
<p id=bibtextext>L'entrée BibTeX a été copiée dans votre presse-papiers.</p>
<textarea id="bibtexcode" readonly></textarea> 
</div>

<script type="text/javascript">
var bibtexdetails = `@misc{desfontainesblogue20140408,
  title = &#123;Gérer ses mails en local : étape 1, sychronisation IMAP avec OfflineIMAP.},
  author = &#123;Damien Desfontaines},
  howpublished = {\\url{https://desfontain.es/blogue/client-mail-1-offlineimap.html}},
  note = &#123;Ted écrit des trucs (blog personnel)},
  year = &#123;2014},
  month = &#123;04}
}`
// We need to use textarea for the tag containing code so we can select it to
// copy it (<pre> wouldn't work), but inputs can't be dynamically resized to fit
// the content, so we compute its size manually. Isn't web development great?
var lines = bibtexdetails.split("\n");
var heigth = lines.length;
var width = Math.max(...(lines.map(line => line.length)));
var button = document.getElementById('showBibtex');
button.addEventListener('click', function (event) {
  bibtex = document.getElementById('bibtex');
  bibtex.style.display = 'block';
  var bibtexcode = document.getElementById('bibtexcode');
  bibtexcode.innerHTML = bibtexdetails;
  bibtexcode.rows = heigth;
  bibtexcode.cols = width;
  bibtexcode.select();
  document.execCommand('copy');
  document.getSelection().removeAllRanges();
});
</script>

<nav>
  <ul class="nav">
    <li>
      <a href="client-mail-2-msmtp.html">← précédent</a>
    </li>
    <li>
      <a href="client-mail-0-introduction.html">suivant →</a>
    </li>
  </ul>
  <ul>
    <li><a href="#menuGlobal">haut de page</a></li>
    <li><a href="index.html">accueil</a></li>
    <li><a href="archives.html">archives</a></li>
  </ul>
</nav>

      <div class="feedback">
        Tout ce que je raconte ici sont mes opinions personnelles, pas celles de
        mon employeur.
        <br>
        Je suis toujours ravi de recevoir des réactions, critiques, questions,
        ou autres commentaires sur ce que j'écris. Envoyez-moi ce qui vous
        chante à <span class="baddirection">se.niatnofsed@neimad</span>.
      </div>
      <footer>
        <p xmlns:dct="http://purl.org/dc/terms/" xmlns:vcard="http://www.w3.org/2001/vcard-rdf/3.0#">
          <br />
          par 
          <a rel="dct:publisher" href="http://desfontain.es/serious-fr.html">
            <span property="dct:title">Damien Desfontaines</span>
          </a> 
          &mdash;
          <a rel="license" href="http://creativecommons.org/publicdomain/zero/1.0/">
            <img src="../cc0.png" style="border-style: none;" alt="CC0" title="Je pense que le concept de propriété intellectuelle n'a aucun sens. Le contenu de ce blog est dans le domaine public."/>
          </a>
          &mdash;
          mis en orbite par <a href="https://getpelican.com">Pelican</a>
        </p>
      </footer>
  </div>
</body>
</html>
